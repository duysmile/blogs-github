Instagram - Thiáº¿t Káº¿ Há»‡ Thá»‘ng cÃ³ gÃ¬ hay? ğŸ’»

Thiáº¿t Káº¿ Há»‡ Thá»‘ng tÆ°Æ¡ng tá»± Instagram cÃ³ khÃ³? vÃ  nhá»¯ng Ä‘iá»u cáº§n lÆ°u Ã½!


Má»™t há»‡ thá»‘ng ráº¥t Ä‘Æ°á»£c cÃ¡c Anh Chá»‹ Em chá»n lÃ m 1 nÆ¡i Ä‘á»ƒ lÆ°u giá»¯ nhá»¯ng ká»‰ niá»ƒm tÆ°á»Ÿng chá»«ng Ä‘Æ¡n giáº£n vá»›i má»™t há»‡ thá»‘ng chuyÃªn dá»¥ng cho viá»‡c upload/download(view) áº¢nh, nhÆ°ng Ä‘á»ƒ cÃ³ Ä‘Æ°á»£c má»™t kiáº¿n trÃºc háº§m há»‘ chá»©a Ä‘Æ°á»£c 1 lÆ°á»£ng traffic cá»±c khá»§ng nhÆ° Instagram lÃ  1 bÃ i toÃ¡n cá»±c kÃ¬ háº§m há»‘ vÃ  phá»©c táº¡p, hÃ£y cÃ¹ng mÃ¬nh tÃ¬m hiá»ƒu vá» cÃ¡c váº¥n Ä‘á» Ä‘á»ƒ thiáº¿t káº¿ 1 há»‡ thá»‘ng tÆ°Æ¡ng tá»± Instagram nhÃ©!


Xin chÃ o, mÃ¬nh lÃ  Khanh Ney, 1 Backend Developer chÃ­nh hiá»‡u sÃ¹ng bÃ¡i cÃ¡c vá»‹ Vua vÃ  mang tÆ° duy cá»§a cÃ¡c vá»‹ Vua giáº£i quyáº¿t váº¥n Ä‘á» vá»›i DIY (Do it Yourself). Hi vá»ng vá»›i kiáº¿n thá»©c cá»§a mÃ¬nh cÃ³ thá»ƒ giÃºp cho cÃ¡c báº¡n chÆ°a tiáº¿p xÃºc vá»›i cÃ¡c váº¥n Ä‘á» cÃ³ thá»ƒ thiáº¿t káº¿ vÃ  dá»± tÃ­nh, Ä‘Ã¡nh gÃ­a cÃ¡c váº¥n Ä‘á» tá»« 1 bÃ i toÃ¡n thiáº¿t káº¿ há»‡ thá»‘ng.


Äá»ƒ Design má»™t System hiá»‡u quáº£, báº¡n cáº§n náº¯m Ä‘Æ°á»£c cÃ¡c yÃªu cáº§u cá»‘t lÃµi tá»« há»‡ thá»‘ng, vÃ  Ä‘Æ°a ra cÃ¡c yáº¿u tá»‘ giÃºp há»‡ thá»‘ng cÃ³ kháº£ nÄƒng má»Ÿ rá»™ng vá» sau.

1/ YÃªu cáº§u Há»‡ Thá»‘ng
1.1/ YÃªu cáº§u báº¯t buá»™c
Cho phÃ©p ngÆ°á»i dÃ¹ng Upload/Download cÃ¡c hÃ¬nh áº£nh cá»§a chÃ­nh há» hoáº·c tá»« cÃ¡c User khÃ¡c
User cÃ³ thá»ƒ tÃ¬m kiáº¿m cÃ¡c thÃ´ng tin nhÆ° tÃªn NgÆ°á»i dÃ¹ng, HÃ¬nh áº£nh, Video
LÃ  1 máº¡ng xÃ£ há»™i, thÃ¬ tÃ­nh nÄƒng theo dÃµi, yÃªu thÃ­ch lÃ  1 pháº§n khÃ´ng thá»ƒ thiáº¿u
HÃ¬nh áº£nh, Video hoáº·c cÃ¡c ná»™i dung khÃ¡c tá»« ngÆ°á»i dÃ¹ng upload sáº½ khÃ´ng máº¥t sau má»™t khoáº£ng time há»‡ thá»‘ng cho phÃ©p lÆ°u trá»¯
Há»‡ thá»‘ng tá»± cÃ³ kháº£ nÄƒng generate vÃ  hiá»ƒn thá»‹ ná»™i dung trÃªn News Feed tá»« táº¥t cáº£ ngÆ°á»i dÃ¹ng Ä‘Ã£ theo dÃµi.
1.2/ YÃªu cáº§u khÃ´ng báº¯t buá»™c
Há»‡ thá»‘ng Ä‘Ã¡p á»©ng vá»›i kháº£ nÄƒng pháº£n há»“i tá»« cÃ¡c yÃªu cáº§u Download/Viewed dÆ°á»›i 200ms
Há»‡ thá»‘ng cáº§n cÃ³ kháº£ nÄƒng Ä‘Ã¡p á»©ng tÃ­nh sáºµn sÃ ng cao (Highly Available)
1.3/ Note
Sá»‘ lÆ°á»£ng hÃ¬nh áº£nh vÃ  cÃ¡c ná»™i dung khÃ¡c sáº½ Ä‘Æ°á»£c User sá»­ dá»¥ng ráº¥t nhiá»u, nÃªn viá»‡c quáº£n lÃ½ Storage má»™t cÃ¡ch hiá»ƒu quáº£ sáº½ Ä‘em láº¡i response-time tháº¥p nháº¥t.
Há»‡ thá»‘ng pháº£i Ä‘áº£m báº£o má»©c Ä‘á»™ an toÃ n dá»¯ liá»‡u (Storage: hÃ¬nh áº£nh, video, â€¦) sáº½ á»Ÿ má»©c Ä‘á»™ 100%
Tá»‰ lá»‡ Read/Write Æ°á»›c tÃ­nh ~= 5/1 (tá»©c trung bÃ¬nh User sáº½ download(view) 5 áº£nh/1 áº£nh upload)
2/ Dá»± tÃ­nh kháº£ nÄƒng lÆ°u trá»¯
giáº£ sá»­ há»‡ thá»‘ng cÃ³ 10M User, vá»›i sá»‘ lÆ°á»£t truy cáº­p trÃªn ngÃ y DAU lÃ  1M User
200.000 hÃ¬nh áº£nh Ä‘Æ°á»£c upload má»—i ngÃ y â†’ ~= 3 photo/s
Trung bÃ¬nh, 1 áº£nh sáº½ cÃ³ dung lÆ°á»£ng ~= 300KB

Náº¿u báº¡n khÃ´ng quan tÃ¢m Ä‘áº¿n viá»‡c tÃ­nh toÃ¡n vÃ  Æ°á»›c chá»«ng vá» cÃ¡c thÃ nh pháº§n dÆ°á»›i Ä‘Ã¢y thÃ¬ cÃ³ thá»ƒ next sang má»¥c tiáº¿p theo nhÃ©!


2.1/ Æ¯á»›c tÃ­nh Traffic

vá»›i tá»‰ lá»‡ read/write ~= 5/1
trung bÃ¬nh má»—i ngÃ y cÃ³ 200.000 hÃ¬nh áº£nh Ä‘Æ°á»£c upload
5 * 200.000(photo/day) = 1.000.000 (photo/day)
-> 1.000.000 / (1 ngÃ y * 24 giá» * 3000 giÃ¢y) ~= 12 photo/s (QPS - queries per second)
vá»›i tá»‰ lá»‡ 5:1 Read/Write

â†’ 5 (5 Read photo/1 Write photo) * 12 photo/s (Query per Second)


=> Request Per Second: 60(rps)


300(KB/photo) * 12 photo/s = 3600KB/s = 3.5MB/s


2.2/ Æ¯á»›c tÃ­nh Storage

200.000(photo/day) * 300(KB/photo) ~= 60GB/day
váº­y vá»›i 1 nÄƒm â†’ 60GB/day * 365 day = 29TB/year

2.3/ Æ¯á»›c tÃ­nh Bandwidth

Vá»›i Write Request(Upload), vá»›i 3 photo/s â†’ tá»•ng dá»¯ liá»‡u Incoming = 3(photo/s)*300(KB/photo) = 900KB/s
Vá»›i Read Request(Download/View), vá»›i 60(Request per second) â†’ Tá»•ng dá»¯ liá»‡u Outcoming = 60(request_photo/s) * 300(KB/photo) ~= 17.5 MB/s

2.4/ Æ¯á»›c tÃ­nh Memory

Náº¿u báº¡n follow Theo rule 20-80, tá»©c 20% cho cÃ¡c Hot Photo
Vá»›i 60(rps) â†’ 1 ngÃ y ta cÃ³: 60 * 3600 seconds * 24 hours = 5.184.000 (Request per Day)
Theo rule 20-80, ta cáº§n: 5.184.000 * 0.2 (20% Hot Photo for Cache) * 300 (KB/Photo) ~= 311GB
3/ Database & Storage



Viá»‡c thiáº¿t káº¿ 1 Database cÃ³ thá»ƒ lÆ°u trá»¯ cÃ¡c thÃ´ng tin vá»›i yÃªu cáº§u trÃªn sáº½ khÃ´ng gÃ¢y khÃ³ khÄƒn nhiá»u cho cÃ¡c báº¡n, NhÆ°ng á»Ÿ gÃ³c Ä‘á»™ HighLevel báº¡n cáº§n cÃ³ 1 cÃ¡ch tiáº¿p cáº­n vá»›i viá»‡c dá»¯ liá»‡u sáº½ bÃ¹ng ná»•, vÃ  kháº£ nÄƒng Latency (Äá»™ Trá»…) lÃ  1 key-design mÃ  báº¡n cáº§n pháº£i hÆ°á»›ng Ä‘áº¿n.
Vá»›i cÃ¡c cá»Ÿ sá»Ÿ dá»¯ liá»‡u hiá»‡n nay nhÆ° SQL vs NoSQL, chÃºng ta cáº§n cÃ³ 1 chiáº¿n lÆ°á»£c tiá»‡p cáº­n phÃ¹ há»£p, chÃºng ta sáº½ cÃ³ 1 vÃ i lÆ°u Ã½ trÆ°á»›c khi viá»‡c chá»n CSDL cho Há»‡ Thá»‘ng nÃ y, nhÆ°:
Sá»‘ lÆ°á»£ng record cáº§n lÆ°u trá»¯: 200.000 records/day â†’ 10 year = 200.000 * 365days * 10 years = 730M records/10year
Má»—i object giáº£ sá»¯ dÆ°á»›i 1K/record(document) (viá»‡c nÃ y báº¡n cÃ³ thá»ƒ theo dÃµi tá»« cÃ¡c CLI DB, hoáº·c Ä‘Ã¡nh gÃ­a qua cÃ¡c filed, vÃ­ dá»¥ vá»›i MongoDB: _id = 12bytes, number = 8bytes,â€¦)
KhÃ´ng cáº§n lÆ°u trá»¯ má»‘i quan há»‡ giá»¯a cÃ¡c báº£ng ghi
Há»‡ thá»‘ng cÃ³ tá»‰ lá»‡ READ cao
â†’ tá»« cÃ¡c lÆ°u trÃªn, ta cÃ³ thá»ƒ Ä‘Æ°a ra cÃ¡c LOáº I DB hiá»‡u quáº£ nhÆ°: key-values(Cassandra), NoSQL (MongoDB)
Vá» storage, chÃºng ta cÃ³ thá»ƒ dÃ¹ng cÃ¡c Storage Distributed file nhÆ° S3, BackBlaze,â€¦
4/ Sharding
Vá»›i cÃ¡c yÃªu cáº§u tá»« há»‡ thá»‘ng:
Há»‡ thá»‘ng Ä‘Ã¡p á»©ng vá»›i kháº£ nÄƒng pháº£n há»“i tá»« cÃ¡c yÃªu cáº§u Download/Viewed dÆ°á»›i 200ms
Há»‡ thá»‘ng cáº§n cÃ³ kháº£ nÄƒng Ä‘Ã¡p á»©ng tÃ­nh sáºµn sÃ ng cao (Highly Available)
Sharding lÃ  1 giáº£i phÃ¡p hiá»‡u quáº£, giÃºp báº¡n phÃ¢n tÃ¡n dá»¯ liá»‡u (1 PHIÃŠN Báº¢N nÃ¢ng cao INDEX Distributed ğŸ˜‚~ mÃ¬nh nghÄ© lÃ  váº­y). GiÃºp báº¡n Scale-Horizontal DB 1 cÃ¡ch hiá»‡u quáº£.
Viá»‡c thá»±c hiá»‡n Sharding sáº½ giÃºp cÃ¡c báº¡n giáº£i quyáº¿t váº¥n Ä‘á» trÃªn, ngoÃ i ra khi cÃ¡c node triá»ƒn khai vá»›i Sharding, náº¿u deploy vá»›i Kiáº¿n TrÃºc Master-Slave (Replica-set) sáº½ giÃºp báº¡n cÃ³ 1 há»‡ thá»‘ng cÃ³ tÃ­nh Sáºµn SÃ ng Cao (Highly Available)






LÆ°u Ã½: Trong quÃ¡ trÃ¬nh tÃ­nh toÃ¡n vá» Metadata lÆ°u trá»¯, náº¿u váº«n Ä‘áº£m báº£o dá»¯ liá»‡u phÃ¡t sinh váº«n náº±m trong vÃ¹ng cho phÃ©p, thÃ¬ báº¡n váº«n cÃ³ thá»ƒ chá»n giáº£i phÃ¡p Scale-up vá»›i viá»‡c tÄƒng háº¡ táº§ng há»‡ thá»‘ng, nhÆ°ng nhÃ¬n chung, vá»›i 1 Há»‡ Thá»‘ng Sharding, vá» sau 5, 10 nÄƒm ná»¯a mÃ¬nh cÅ©ng cáº£m tháº¥y an tÃ¢m, viá»‡c cÃ²n láº¡i cá»§a mÃ¬nh chá»‰ lÃ  lÃ m tháº¿ nÃ o chá»n cÃ¡c SHARD-KEY (tÆ°Æ¡ng tá»± mongod indexed váº­y), vÃ  cáº§n test tÃ¹m lum thá»© Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng viá»‡c báº¡n phÃ¡n quyáº¿t nÃ³ sáº½ lÃ  Sá»° Sá»NG CÃ’N khi ra mÃ´i trÆ°á»ng Production ğŸ˜ .

5/ NewsFeed - LÃ  sá»± sá»± sá»‘ng cho háº§u háº¿t Anh/Chá»‹/Em dÃ¹ng Fb hoáº·c Instagram
Vá»›i cÃ¡c cÃ¡ch truyá»n thá»‘ng (mÃ¬nh hay sá»­ dá»¥ng trÆ°á»›c Ä‘Ã¢y), quy trÃ¬nh táº¡o ra 1 NewsFeed sáº½ nhÆ° sau
Láº¥y danh sÃ¡ch cÃ¡c User Ä‘ang theo dÃµi â†’ Query Photo má»›i nháº¥t cá»§a tá»«ng User
Sau Ä‘Ã³ query thÃªm cÃ¡c thÃ´ng tin metadata (photo, user, â€¦) â†’ response cho ngÆ°á»i dÃ¹ng
Sá»­ dá»¥ng 1 thuáº­t toÃ¡n gÃ¬ Ä‘Ã³, Ä‘á»ƒ sáº¯p xáº¿p thá»© tá»± cÃ¡c hÃ¬nh áº£nh

Quy trÃ¬nh sáº½ nhÆ° sau Query â†’ Sorting â†’ Merging â†’ Ranking


Problems: Vá»›i cÃ¡ch tiáº¿p cáº­n nÃ y chÃºng ta sáº½ gáº·p cÃ¡c váº¥n Ä‘á», nhÆ° sau:

Lantency cao (DB), Ä‘áº¿n tá»« viá»‡c Query tá»« nhiá»u báº£ng (tá»« 1 request)
Latency cao trong viá»‡c thá»±c hiá»‡n quy trÃ¬nh tá»« Query â†’ Sorting â†’ Merging â†’ Ranking (Logic).

Solution:

Thá»±c hiá»‡n cÃ¡c tÃ¡c vá»¥ ngáº§m hoáº·c trigger â†’ Pre-generating NewsFeed
Chi tiáº¿t vÃ­ dá»¥ nhÆ° sau:
Táº¡o 1 table generateNewsFeed, cÃ³ liÃªn káº¿t:
Users (nhá»¯ng ngÆ°á»i nháº­n tin + top Ranking)
Author
â€¦metadata (newsFeed ref, hoáº·c info NewsFeed)
Má»—i láº§n User_táº¡o 1 Post(Photo),
Server thá»±c hiá»‡n tÃ¬m kiáº¿m â†’ update(táº¡o record generateNewsFeed cháº³ng háº¡n), xá»­ lÃ½ cÃ¡c thuáº­t toÃ¡n Ranking â†’ cáº­p nháº­t DB.
Hoáº·c cÃ³ thá»ƒ cháº¡y cÃ¡c Schedule-Task Event Ä‘á»ƒ xá»­ lÃ½ cÃ¡c viá»‡c create/update trÃªn table generateNewsFeed
Khi User request NewsFeed â†’ Server Query trÃªn table generateNewsFeed ğŸ¤©
Váº¥n Ä‘á» tiáº¿p theo mÃ  ta cáº§m váº¯n nÃ£o suy nghÄ© lÃ , Váº­y NewsFeed sáº½ gá»­i Cho Clients(Users) nhÆ° tháº¿ nÃ o?chÃºng ta cÃ³ cÃ¡c cÃ¡ch tiáº¿p cáº­n nhÆ° sau:
1/ Pull, tá»©c lÃ  Clients cáº§n gá»­i cÃ¡c yÃªu cáº§u Ä‘á»ƒ nháº­n Ä‘Æ°á»£c NewsFeed, nhÆ°ng váº¥n Ä‘á» vÃ  tá»« cÃ¡ch tiáº¿p cáº­n nÃ y nhÆ° sau:
Clients sáº½ request náº¿u muá»‘n cÃ³ NewsFeed (viá»‡c nÃ y nhÆ° khi báº¡n dÃ¹ng App Mobile Facebook, báº¡n cáº§n vuá»‘t xuá»‘ng tá»« mÃ n hÃ¬nh Ä‘á»ƒ nháº­n Ä‘Æ°á»£c cÃ¡c ná»™i dung NewsFeed má»›i) ğŸ˜”
Server Ä‘Ã´i lÃºc sáº½ khÃ´ng cÃ³ dá»¯ liá»‡u tráº£ vá» (cÃ³ thá»ƒ do Ä‘Ã£ láº¥y táº¥t cáº£ NewsFeed, hoáº·c khÃ´ng cÃ³ NewsFeed má»›i tá»« cÃ¡c User Ä‘ang theo dÃµi)
2/ Push, tá»©c khi 1 trong danh sÃ¡ch cÃ¡c User Ä‘ang theo dÃµi táº¡o 1 post má»›i, Server sáº½ tá»± thá»±c hiá»‡n tÃ¡c vá»¥ gá»­i cho cÃ¡c Client Ä‘ang follow User nÃ y, cÃ¡ch tiáº¿p cáº­n nÃ y cÅ©ng cÃ³ nhá»¯ng váº¥n Ä‘á» nhÆ° sau:
Äá»‘i vá»›i cÃ¡c User cÃ³ lÆ°á»£ng User (mÃ¬nh Ä‘ang theo dÃµi) Lá»šN (vÃ­ dá»¥ 100nghÃ¬n), thÃ¬ há»‡ thá»‘ng sáº½ push NewsFeed liÃªn tá»¥c, náº¿u cÃ¡c Anh ChÃ ng/CÃ´ NÃ ng Ä‘áº¥y Ä‘Äƒng áº£nh vá»›i 1 táº§ng suáº¥t chÃ³ng máº·t ğŸ˜•
NhÆ°ng vÆ°á»£t qua cÃ¡c trá»Ÿ ngáº¡i Ä‘Ã³, giáº£ sá»­ Ä‘á»‘i vá»›i cÃ¡c User cÃ³ lÆ°á»£ng theo dÃµi <100nghÃ¬n User, thÃ¬ xem nhÆ° táº¡m cháº¥p nháº­n, váº­y ta pháº£i chá»n Giao Thá»©c nÃ o Ä‘á»ƒ implement Push, cÃ³ ráº¥t nhiá»u loáº¡i Giao Thá»©c, nhÆ°ng mÃ¬nh chá»‰ Ä‘Æ°a ra 1 vÃ i gá»£i Ã½ nhÆ°: HTTP Polling, HTTP Long Polling, WebSocket, â€¦ báº¡n cÃ³ thá»ƒ xem thÃªm thÃ´ng tin vÃ  Ä‘Ã¡nh giÃ¡ â†’ chá»n lá»±a phÃ¹ há»£p vá»›i há»‡ thá»‘ng cÃ¡c báº¡n nhÃ©
3/ Äi vá»›i pháº­t máº·c Ã¡o cÃ  sa, Ä‘i vá»›i ma máº·c Ã¡o giáº¥y ğŸ‘»
Tá»« viá»‡c phÃ¢n tÃ­ch Æ°u/nhÆ°á»£c Ä‘iá»ƒm ta cÃ³ thá»ƒ chá»n 1 cÃ¡ch mÃ  giÃºp tá»‘i Æ°u hoÃ¡ trong viá»‡c send NewsFeed cho Clients, nhÆ° sau:
1/ Äá»‘i vá»›i cÃ¡c User cÃ³ lÆ°á»£ng Ä‘ang theo dÃµi ÃT (<100nghÃ¬n), ta cÃ³ thá»ƒ chá»n PUSH Ä‘á»ƒ gá»­i NewsFeed cho cÃ¡c Client Ä‘Ã³
2/ Äá»‘i vá»›i cÃ¡c User cÃ³ lÆ°á»£ng Ä‘ang theo dÃµi CAO:
vá»›i cÃ¡c NewsFeed cÃ³ lÆ°á»£ng RANKING cao hoáº·c 1 tiÃªu chÃ­ gÃ¬ Ä‘Ã³ mÃ  Server Æ°u tiÃªn: â†’ cÃ³ thá»ƒ dÃ¹ng PUSH-based Ä‘á»ƒ gá»­i NewsFeed
vá»›i cÃ¡c NewsFeed bÃ¬nh thÆ°á»ng â†’ sá»­ dÃ¹ng PULL-based Ä‘á»ƒ xem cÃ¡c NewsFeed
6/ Caching

ChÃºng ta cÃ³ ráº¥t nhiá»u cáº¥p Ä‘á»™ cache: Client Cache, CDN Cache, Webserver Cache, Application Cache, DB Cache, â€¦nhÆ°ng chÃºng ta chá»‰ sáº½ Ä‘á» cáº­p vá» Application Cache

Memcache hoáº·c cÃ¡c Enginee khÃ¡c nhÆ° Redis sáº½ lÃ  1 Tool giÃºp báº¡n tá»‘i Æ°u hoÃ¡ cÃ¡c cÃ¢u tÃ¬m kiáº¿m (HOTPOST/Photo). dá»±a vÃ o cÃ¡c cÆ¡ cháº¿, nhÆ°:
LRU(Least Recently Used)
LFU(Least Frequency Used)

â†’Vá»›i há»‡ thá»‘ng hiá»‡n táº¡i, NewsFeed sáº½ Æ°u tiÃªn Ranking theo tiÃªu chÃ­ Thá»i Gian (Gáº§n Nháº¥t) â†’ nÃªn chÃºng ta sáº½ chá»n LRU cho viá»‡c Cache eviction

LÆ°u Ã½:
TuÃ¢n theo quy luáº­t 20% lÆ°á»£ng Traffic
Viá»‡c cache sáº½ dáº«n Ä‘áº¿n cÃ¡c váº¥n Ä‘á» Ä‘au Ä‘áº§u nhÆ° Invalidate Cache, nÃªn hÃ£y lÃ m chá»§ má»i cuá»™c chÆ¡i Ä‘á»ƒ khÃ´ng pháº£i dÃ¹ng cÃ¢u â€˜nÃ y lÃ  Featureâ€™ nhÃ©.

Nguá»“n: https://www.facebook.com/notes/730544164474628/
